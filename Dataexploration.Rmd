---
title: "Exploratory Analysis"
author: "Eva Jason"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(tidyr)
```

```{r}
df_all <- read.csv("../HPS_Week17_PUF_CSV/pulse2020_puf_17.csv") 
```

```{r}
df <- mutate(df_all, age = 2023-TBIRTH_YEAR) %>%
  mutate(ANXIOUS = ifelse(ANXIOUS < 1, 0, ANXIOUS)) %>%
  mutate(WORRY = ifelse(WORRY < 1, 0, WORRY)) %>%
  mutate(INTEREST = ifelse(INTEREST < 1, 0, INTEREST)) %>%
  mutate(DOWN = ifelse(DOWN < 1, 0, DOWN)) %>%
  mutate(mental_health_score = rowSums(pick(ANXIOUS,WORRY,INTEREST,DOWN))) %>%
  mutate(issue = ifelse(mental_health_score<=4, 0, 1)) %>%
  mutate(age_group = case_when(
    age < 30 ~ "20-29",
    age < 40 & age >29 ~ "30-39",
    age < 50 & age >39 ~ "40-49",
    age < 60 & age > 49 ~ "50-59",
    age < 70 & age >59 ~ "60-69",
    age < 80 & age >69 ~ "70-79",
    age > 79 ~ "80+"
  ))
```

## Summary Statistics

```{r}
ggplot(df, aes(age)) +
  geom_bar() +
  theme_minimal()

avg_age <- mean(df$age)
median_age <- median(df$age)
```

A total of `r nrow(df)` responded to the Week 17 surrvey. The average age of respondents was `r round(avg_age,2)` and the median age was  `r round(median_age,2)`.

```{r}
df_mental_health <- select(df, ANXIOUS, WORRY, INTEREST, DOWN, age) %>%
  pivot_longer(cols = c(ANXIOUS,WORRY,INTEREST,DOWN), names_to ="issue", values_to = "score") %>%
  mutate(age_group = case_when(
    age < 30 ~ "20-29",
    age < 40 & age > 29 ~ "30-39",
    age < 50 & age > 39 ~ "40-49",
    age < 60 & age > 49 ~ "50-59",
    age < 70 & age > 59 ~ "60-69",
    age < 80 & age > 69 ~ "70-79",
    age > 79 ~ "80+"
  ))

df_groups <- group_by(df_mental_health, issue, age_group, score) %>%
  summarise(total_issue_age_score = n())

df_groups_age_group_total_score <-  group_by(df_mental_health, age_group, issue) %>%
  summarise(total_issue_age = n())

df_groups <- merge(df_groups, df_groups_age_group_total_score) %>%
  mutate(percent = total_issue_age_score/total_issue_age)

ggplot(df_groups, aes(x=score, y = percent)) +
  geom_col() +
  facet_grid(issue~age_group) +
  theme_minimal()
```

"Over the last 7 days, how often have you been bothered by the following problems ... Feeling
nervous, anxious, or on edge? Would you say not at all, several days, more than
half the days, or nearly every day? Select only one answer."

"1) Not at all
2) Several days
3) More than half the days
4) Nearly every day 
-99) Question seen but category not selected
-88) Missing / Did not report"


"Over the last 7 days, how often have you been bothered by the following problems ... Not being
able to stop or control worrying? Would you say not at all, several days, more
than half the days, or nearly every day? Select only one answer."
"1) Not at all
2) Several days
3) More than half the days
4) Nearly every day 
-99) Question seen but category not selected
-88) Missing / Did not report"


"Over the last 7 days, how often have you been bothered by ... having little interest or
pleasure in doing things? Would you say not at all, several days, more than
half the days, or nearly every day? Select only one answer."
"1) Not at all
2) Several days
3) More than half the days
4) Nearly every day 
-99) Question seen but category not selected
-88) Missing / Did not report"


"Over the last 7 days, how often have you been bothered by ... feeling down, depressed, or
hopeless? Would you say not at all, several days, more than half the days, or
nearly every day? Select only one answer."

1) Not at all
2) Several days
3) More than half the days
4) Nearly every day 
-99) Question seen but category not selected
-88) Missing / Did not report"


```{r}
df_groups_y_n_issue <- group_by(df, issue, age_group) %>%
  summarise(total_issue_age_score = n())

df_groups_age_group <-  group_by(df, age_group) %>%
  summarise(total_age_group = n())

df_groups <- merge(df_groups_y_n_issue, df_groups_age_group) %>%
  mutate(percent = total_issue_age_score/total_age_group)%>%
  mutate(has_issue = ifelse(issue ==1, "YES", "NO"))

ggplot(df_groups, aes(x=age_group, y = percent, fill = has_issue)) +
  geom_col(position="dodge") +
  theme_minimal()
```

```{r}
agg.age <- aggregate(x = issue ~ age, data= df, FUN = sum)
agg.age  <- cbind(agg.age, aggregate(x = issue ~ age,data= df, FUN = length))
names(agg.age)[4] <- 'total'

mod.fit <- glm(formula = issue ~ age, family = binomial(link = logit), data = df)
mod.fit2 <- glm(formula = issue/total ~ age,family = binomial(link='logit'), data = agg.age, weight = total)

curve(predict(mod.fit2, data.frame(age=x), type="response"),from=min(agg.age$age), to=max(agg.age$age), ylab="Probability", xlab="Age")
```
