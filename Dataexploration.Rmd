---
title: "Exploratory Analysis"
author: "Eva Jason"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(tidyr)
library(kableExtra)
library(lmtest)
```

```{r}
df_all <- read.csv("../HPS_Week17_PUF_CSV/pulse2020_puf_17.csv") 
```

```{r}
# "issue" corresponds to 0 if yours score is < 4 and 1 if your score is > 4

df <- mutate(df_all, age = 2023-TBIRTH_YEAR) %>%
  mutate(ANXIOUS = ifelse(ANXIOUS < 1, 0, ANXIOUS)) %>%
  mutate(WORRY = ifelse(WORRY < 1, 0, WORRY)) %>%
  mutate(INTEREST = ifelse(INTEREST < 1, 0, INTEREST)) %>%
  mutate(DOWN = ifelse(DOWN < 1, 0, DOWN)) %>%
  mutate(mental_health_score = rowSums(pick(ANXIOUS,WORRY,INTEREST,DOWN))) %>%
  mutate(issue = ifelse(mental_health_score<=4, 0, 1)) %>%
  mutate(age_group = case_when(
    age < 30 ~ "20-29",
    age < 40 & age > 29 ~ "30-39",
    age < 50 & age > 39 ~ "40-49",
    age < 60 & age > 49 ~ "50-59",
    age < 70 & age > 59 ~ "60-69",
    age < 80 & age > 69 ~ "70-79",
    age > 79 ~ "80+"
  )) %>%
  mutate(TW_START = as.character(TW_START))
```

## Summary Statistics

```{r}
ggplot(df, aes(age)) +
  geom_bar() +
  theme_minimal()

avg_age <- mean(df$age)
median_age <- median(df$age)
```

A total of `r nrow(df)` responded to the Week 17 surrvey. The average age of respondents was `r round(avg_age,2)` and the median age was  `r round(median_age,2)`.

```{r}
df_mental_health <- select(df, ANXIOUS, WORRY, INTEREST, DOWN, age) %>%
  pivot_longer(cols = c(ANXIOUS,WORRY,INTEREST,DOWN), names_to ="issue", values_to = "score") %>%
  mutate(age_group = case_when(
    age < 30 ~ "20-29",
    age < 40 & age > 29 ~ "30-39",
    age < 50 & age > 39 ~ "40-49",
    age < 60 & age > 49 ~ "50-59",
    age < 70 & age > 59 ~ "60-69",
    age < 80 & age > 69 ~ "70-79",
    age > 79 ~ "80+"
  ))

df_groups <- group_by(df_mental_health, issue, age_group, score) %>%
  summarise(total_issue_age_score = n())

df_groups_age_group_total_score <-  group_by(df_mental_health, age_group, issue) %>%
  summarise(total_issue_age = n())

df_groups <- merge(df_groups, df_groups_age_group_total_score) %>%
  mutate(percent = total_issue_age_score/total_issue_age)

ggplot(df_groups, aes(x=score, y = percent)) +
  geom_col() +
  facet_grid(issue~age_group) +
  theme_minimal()
```

"Over the last 7 days, how often have you been bothered by the following problems ... Feeling
nervous, anxious, or on edge? Would you say not at all, several days, more than
half the days, or nearly every day? Select only one answer."

"1) Not at all
2) Several days
3) More than half the days
4) Nearly every day 
-99) Question seen but category not selected
-88) Missing / Did not report"


"Over the last 7 days, how often have you been bothered by the following problems ... Not being
able to stop or control worrying? Would you say not at all, several days, more
than half the days, or nearly every day? Select only one answer."
"1) Not at all
2) Several days
3) More than half the days
4) Nearly every day 
-99) Question seen but category not selected
-88) Missing / Did not report"


"Over the last 7 days, how often have you been bothered by ... having little interest or
pleasure in doing things? Would you say not at all, several days, more than
half the days, or nearly every day? Select only one answer."
"1) Not at all
2) Several days
3) More than half the days
4) Nearly every day 
-99) Question seen but category not selected
-88) Missing / Did not report"


"Over the last 7 days, how often have you been bothered by ... feeling down, depressed, or
hopeless? Would you say not at all, several days, more than half the days, or
nearly every day? Select only one answer."

1) Not at all
2) Several days
3) More than half the days
4) Nearly every day 
-99) Question seen but category not selected
-88) Missing / Did not report"


```{r}
df_groups_y_n_issue <- group_by(df, issue, age_group) %>%
  summarise(total_issue_age_score = n())

df_groups_age_group <-  group_by(df, age_group) %>%
  summarise(total_age_group = n())

df_groups <- merge(df_groups_y_n_issue, df_groups_age_group) %>%
  mutate(percent = total_issue_age_score/total_age_group)%>%
  mutate(has_issue = ifelse(issue ==1, "YES", "NO"))

ggplot(df_groups, aes(x=age_group, y = percent, fill = has_issue)) +
  geom_col(position="dodge") +
  theme_minimal()
```

```{r}
mod.fit <- glm(formula = issue ~ age, family = binomial(link = logit), data = df)
#curve(predict(mod.fit, data.frame(age=x), type="response"),from=min(df$age), to=max(df$age), ylab="Probability", xlab="Age")
df$fitted.values <- mod.fit$fitted.values

ggplot(df, aes(x = age, y = fitted.values)) +
  geom_line() +
  theme_minimal()
```

```{r}
agg.age <- aggregate(x = issue ~ age, data= df, FUN = sum)
agg.age  <- cbind(agg.age, aggregate(x = issue ~ age,data= df, FUN = length))
names(agg.age)[4] <- 'total'

mod.fit2 <- glm(formula = issue/total ~ age,family = binomial(link='logit'), data = agg.age, weight = total)

curve(predict(mod.fit2, data.frame(age=x), type="response"),from=min(agg.age$age), to=max(agg.age$age), ylab="Probability", xlab="Age")
```

```{r}
education_level <- select(df,EEDUC) %>% 
  mutate(EEDUC = as.character(EEDUC)) %>%
  group_by(EEDUC) %>%
  summarise(total = n())

tele_work <- select(df,TW_START) %>% 
  mutate(TW_START = as.character(TW_START)) %>%
  group_by(TW_START) %>%
  summarise(total = n()) %>%
  mutate(percent = paste0(round(total/nrow(df),2)*100,"%"))

kable(tele_work)  #%>%
  #save_kable("telework.pdf")
```
Working from home is sometimes referred to as telework. Did any adults in this household substitute some or all of their typical in-person work for telework because of the coronavirus pandemic, including yourself?  Select only one answer.

Teleworking start due to COVID
"1) Yes, at least one adult substituted some or all of their typical in-person work for telework
2) No, no adults substituted their typical in-person work for telework
3) No, there has been no change in telework
-99) Question seen but category not selected
-88) Missing / Did not report"


```{r}
df_activity <- select(df,FEWRTRANS,PLNDTRIPS,CNCLDTRPS,TW_START,CHNGHOW1,CHNGHOW2,CHNGHOW3,CHNGHOW4,CHNGHOW5,CHNGHOW6,CHNGHOW7,CHNGHOW8,CHNGHOW9,CHNGHOW10,CHNGHOW11,CHNGHOW12)

df_activity <- 
  
df_change <- select(df, starts_with("CHNGHOW"))

df_change[df_change == -99] <- 0
df_change[df_change == -88] <- 0

df_total_change <- colSums(df_change)

df_change <- data.frame(category = colnames(df_change), total =colSums(df_change)) %>%
  mutate(total = as.numeric(total)) %>%
  mutate(percentage = total/nrow(df_change)) %>%
  mutate(percent = paste0(round(percentage, 2)*100, "%"))

kable(select(df_change, category, percent), row.names = F)
```


How did spending or shopping change	In the last 7 days, which of the following changes have you or your household made to your spending or shopping? Select all that apply. 
"1) Made more purchases online (as opposed to in store)
-99) Question seen but category not selected
-88) Missing / Did not report"	
All persons born before 2002	
	
How did spending or shopping change	In the last 7 days, which of the following changes have you or your household made to your spending or shopping? Select all that apply. 
"1) Made more purchases by curbside pick-up (as opposed to in store)
-99) Question seen but category not selected
-88) Missing / Did not report"	
All persons born before 2002	
	
How did spending or shopping change	In the last 7 days, which of the following changes have you or your household made to your spending or shopping? Select all that apply. 
"1) More purchases in-store (as opposed to purchases online or curbside pickup)
-99) Question seen but category not selected
-88) Missing / Did not report"	
All persons born before 2002	
	
How did spending or shopping change	In the last 7 days, which of the following changes have you or your household made to your spending or shopping? Select all that apply. 
"1) Increased use of credit cards or smartphone apps for purchases, instead of using cash 
-99) Question seen but category not selected
-88) Missing / Did not report"	
All persons born before 2002	
	
How did spending or shopping change	In the last 7 days, which of the following changes have you or your household made to your spending or shopping? Select all that apply. 
"1) Increased use of cash instead of using credit cards or smartphone apps for purchases
-99) Question seen but category not selected
-88) Missing / Did not report"	
All persons born before 2002	
	
How did spending or shopping change	In the last 7 days, which of the following changes have you or your household made to your spending or shopping? Select all that apply. 
"1) Avoided eating at restaurants
-99) Question seen but category not selected
-88) Missing / Did not report"	
All persons born before 2002	
	
How did spending or shopping change	In the last 7 days, which of the following changes have you or your household made to your spending or shopping? Select all that apply. 
"1) Resumed eating at restaurants
-99) Question seen but category not selected
-88) Missing / Did not report"	
All persons born before 2002	
	
How did spending or shopping change	In the last 7 days, which of the following changes have you or your household made to your spending or shopping? Select all that apply. 
"1) Canceled or postponed in-person medical or dental appointments 
-99) Question seen but category not selected
-88) Missing / Did not report"	
All persons born before 2002	
	
How did spending or shopping change	In the last 7 days, which of the following changes have you or your household made to your spending or shopping? Select all that apply. 
"1) Attended in-person medical or dental appointments
-99) Question seen but category not selected
-88) Missing / Did not report"	
All persons born before 2002	
	
How did spending or shopping change	In the last 7 days, which of the following changes have you or your household made to your spending or shopping? Select all that apply. 
"1) Canceled or postponed housekeeping or caregiving services
-99) Question seen but category not selected
-88) Missing / Did not report"	
All persons born before 2002	
	
How did spending or shopping change	In the last 7 days, which of the following changes have you or your household made to your spending or shopping? Select all that apply. 
"1) Resumed or started new housekeeping or caregiving services 
-99) Question seen but category not selected
-88) Missing / Did not report"	
All persons born before 2002	
	
How did spending or shopping change	In the last 7 days, which of the following changes have you or your household made to your spending or shopping? Select all that apply. 
"1) Did not make any changes to spending or shopping behavior
-99) Question seen but category not selected
-88) Missing / Did not report"	
All persons born before 2002	


## CHNGHOW + WHYCHNGD

```{r}
# changed_shopping_habits_online = 1 means Made more purchases online (as opposed to in store)
# changed_shopping_habits_online = 0 means didn't Made more purchases online (as opposed to in store)

# changed_shopping_habits_curbside = 1 Made more purchases by curbside pick-up (as opposed to in store)
# changed_shopping_habits_curbside = 0 didn't Made more purchases by curbside pick-up (as opposed to in store)

# change_restaurants = 1 Avoided eating at restaurants
# change_restaurants = 0 didn't Avoided eating at restaurants

# change_appointments = 1 Canceled or postponed in-person medical or dental appointments 
# change_appointments = 0 didn't Canceled or postponed in-person medical or dental appointments 

# change_caregiving =1 Canceled or postponed housekeeping or caregiving services
# change_caregiving = 0 didn't Canceled or postponed housekeeping or caregiving services

df <- mutate(df, changed_shopping_habits_online = ifelse(CHNGHOW1 == 1, 1, 0)) %>%
  mutate(changed_shopping_habits_curbside = ifelse(CHNGHOW2 == 1, 1, 0)) %>%
  mutate(changed_restaurants = ifelse(CHNGHOW6 == 1, 1, 0)) %>%
  mutate(changed_appointments = ifelse(CHNGHOW8 == 1, 1, 0)) %>%
  mutate(changed_caregiving = ifelse(CHNGHOW10 == 1, 1, 0)) %>%
  mutate(total_changed = rowSums(select(.,starts_with("changed")))) %>%
  mutate(changed_bin = total_changed >0) %>%
  mutate(change_due_to_risk = WHYCHNGD3 ==1 ) %>%
  mutate(behavior_change_due_risk = changed_bin & change_due_to_risk)

#behavior_change_due_risk is true if the person changed their behavior because of high risk
```

## planned trips 

```{r}
# canceled_trip_due_to_covid TRUE means "Were any of these trips canceled because of the coronavirus pandemic? Include trips you had not made travel reservations or arrangements for in your answer. Select only one answer."
# FALSE means they didn't cancel due to covid or didn't have a trip planned
df <- mutate(df, canceled_trip_due_to_covid = CNCLDTRPS==1)
```

## remote learning for children

```{r}
# if there were children at home, did they stop going in person
df <- mutate(df, children_learn_from_home = ifelse(TEACH1 == 1 | TEACH2 == 1 | TEACH3 == 1, T, F))
```

```{r}
#if they started telework, then it is TRUE
df <- mutate(df, telework = TW_START== 1)
```
"1) Yes, at least one adult substituted some or all of their typical in-person work for telework
2) No, no adults substituted their typical in-person work for telework
3) No, there has been no change in telework
-99) Question seen but category not selected
-88) Missing / Did not report"

```{r}
#if they took fewer trips to stores, then it is TRUE
df <- mutate(df, fewer_trips = FEWRTRIPS == 1)
```

```{r}
#if they took fewer trips on transit, then it is TRUE
df <- mutate(df, fewer_trips_transit = FEWRTRANS == 1) %>%
  mutate(race = as.character(RRACE))

df_mod <- select(df, race, issue, telework,fewer_trips,fewer_trips_transit,children_learn_from_home,behavior_change_due_risk,canceled_trip_due_to_covid)
```

# Plots about variables of interest

```{r}
df2 <- group_by(df_mod, race) %>% 
  summarise(across(everything(), sum), total_each_race = n()) %>%
  pivot_longer(-c(race,total_each_race), names_to = "activity", values_to = "total_people") %>%
  mutate(percent_total = (total_people/total_each_race))

ggplot(df2, aes(x = activity, y = percent_total, fill = race)) + 
  geom_bar(position="dodge", stat="identity") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, hjust=.2)) +
  ylim(c(0,1))

df_mod <- select(df, age_group, telework,fewer_trips,fewer_trips_transit,children_learn_from_home,behavior_change_due_risk,canceled_trip_due_to_covid)
df3 <- group_by(df_mod, age_group) %>% 
  summarise(across(everything(), sum), total_each_age_group = n()) %>%
  pivot_longer(-c(age_group,total_each_age_group), names_to = "activity", values_to = "total_people") %>%
  mutate(percent_total = (total_people/total_each_age_group))

ggplot(df3, aes(x = activity, y = percent_total, fill = age_group)) + 
  geom_bar(position="dodge", stat="identity") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, hjust=.2)) +
  ylim(c(0,1))
```

## Variable Selection

```{r}
mod.fit <- glm(issue ~ telework + fewer_trips + fewer_trips_transit + children_learn_from_home + behavior_change_due_risk + canceled_trip_due_to_covid + age, family = binomial, data=df)

mod.fit_age <- glm(issue ~ (telework + fewer_trips + fewer_trips_transit + children_learn_from_home + behavior_change_due_risk + canceled_trip_due_to_covid)*age_group, family = binomial, data=df)

mod.fit_age2 <- glm(issue ~ telework:age_group + fewer_trips:age_group + fewer_trips_transit:age_group + children_learn_from_home:age_group + behavior_change_due_risk:age_group + canceled_trip_due_to_covid:age_group, family = binomial, data=df)

lrtest(mod.fit_age, mod.fit_age2)

#mod.fit_race <- glm(issue ~ (telework + fewer_trips + fewer_trips_transit + children_learn_from_home + behavior_change_due_risk + canceled_trip_due_to_covid)*race, family = binomial, data=df)
```

```{r, eval=F}
mod.fit_poisson <- glm(mental_health_score ~ (telework + fewer_trips + fewer_trips_transit + children_learn_from_home + behavior_change_due_risk + canceled_trip_due_to_covid)*age_group, family = poisson, data=df)

ggplot(df, aes(x=mental_health_score)) +
  geom_bar() +
  theme_minimal()
```
